import React, { useEffect, useState } from 'react';
import { CgDanger } from 'react-icons/cg';
import { useDispatch, useSelector } from 'react-redux';
import { useHistory } from 'react-router-dom';
import logo from '../../images/logo.png';
import { fetchToken, loggedInAction } from '../../redux/actions';
import Style from './login.module.css';

function Login() {
  const [user, setUser] = useState({ username: '', password: '' });
  const [loginFail, setLoginFail] = useState();
  const dispatch = useDispatch();
  const history = useHistory();

  const login = useSelector((state) => state.login);

  const handleChange = ({ target }) => {
    const { name, value } = target;
    setUser((previousState) => ({
      ...previousState,
      [name]: value,
    }));
  };

  const handleSubmit = (event) => {
    event.preventDefault();
    dispatch(fetchToken(user));
    if (history.location.pathname) setLoginFail(login.non_field_errors);
  };

  useEffect(() => {
    (function isLogged() {
      if (login) {
        if (login.token) {
          dispatch(loggedInAction(true));
          history.push('/dashboard');
        } else setLoginFail(login.non_field_errors ? login.non_field_errors[0] : '');
      }
    }());
  }, [login]);

  return (
    <div className={Style.container}>
      <form onSubmit={handleSubmit}>
        <img src={logo} alt="logomarca" />
        <div className={Style.formGroup}>
          <label htmlFor="username">
            <input
              type="text"
              className={Style.formControl}
              name="username"
              id="username"
              placeholder="usuÃ¡rio"
              value={user.username}
              onChange={handleChange}
            />
          </label>
        </div>
        <div className={Style.formGroup}>
          <label htmlFor="password">
            <input
              type="password"
              className={Style.formControl}
              name="password"
              id="password"
              placeholder="senha"
              value={user.password}
              onChange={handleChange}
            />
          </label>
        </div>
        <button
          type="submit"
          className={Style.button}
        >
          Login
        </button>
        { loginFail && (
          <div className={Style.fail}>
            <CgDanger />
            {' '}
            {loginFail}
          </div>
        )}
      </form>
    </div>
  );
}

export default Login;
