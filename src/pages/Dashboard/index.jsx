import React, { useEffect } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import CardHosts from '../../components/cards/hosts';
import CardRisk from '../../components/cards/risk';
import CardVulnerabilities from '../../components/cards/vulnerabilities';
import { cardsAction, chartsAction, hostsAction } from '../../redux/actions';
import getCards from '../../requests/getCards';
import getCharts from '../../requests/getCharts';
import getHosts from '../../requests/getHosts';
import Style from './dashboard.module.css';

function Dashboard() {
  const { token } = useSelector((state) => state.login);
  const dispatch = useDispatch();

  const setCardsRedux = async () => {
    const host = await getCards(token, 'total_hosts');
    const vulnerability = await getCards(token, 'total_vulnerabilities');
    const averageRisk = await getCards(token, 'average_risk');

    dispatch(cardsAction({ ...host, ...vulnerability, ...averageRisk }));
  };

  const setChartsRedux = async () => {
    const severity = await getCharts(token, 'severity');
    const topAssets = await getCharts(token, 'top_assets');

    dispatch(chartsAction({ severity, topAssets }));
  };

  useEffect(() => {
    async function getData() {
      const data = await getHosts(token);
      dispatch(hostsAction((data)));
      setCardsRedux();
      setChartsRedux();
    }
    getData();
  }, []);

  return (
    <div className={Style.container}>
      <section className={Style.dashboard}>
        <div className={Style.cards_container}>
          <CardHosts />
          <CardVulnerabilities />
          <CardRisk />
        </div>
        <div className={Style.charts_container} />
      </section>
    </div>
  );
}

export default Dashboard;
